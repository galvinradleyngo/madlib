<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mad Lib Prompt Generator</title>
    
    <!-- Google Fonts for a fun, clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* Custom font for the body */
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Simple animation for dialogue bubbles */
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .bubble {
            animation: pop-in 0.3s ease-out forwards;
        }
        /* Hide scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #notification {
            transition: transform 0.5s ease-in-out;
        }
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-5">

    <!-- Presenter View Container -->
    <div id="presenter-view" class="relative bg-white rounded-2xl shadow-xl p-8 sm:p-12 text-center w-full max-w-3xl transform transition-all">
        <div class="absolute top-5 right-5 flex items-center gap-2">
            <button id="language-toggle-btn" title="Switch Language" class="text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-full p-2 transition-colors">
                 <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" class="h-8 w-8"><g clip-path="url(#a)"><path fill="#0039A6" d="M0 0h24v24H0z"/><path fill="#fff" d="M0 0h24v12H0z"/><path fill="#CE1126" d="M0 12h24v12H0z"/><path fill="#fff" d="m0 0 12.5 12L0 24V0z"/><path fill="#FCD116" d="m4.61 14.8-1.74-.7.43-1.9 1.9.44.7-1.74 1.83 1-1 1.83-1.72-.7Zm-.7-5.6.43 1.9 1.74-.7-1-1.83-1.83 1 .7 1.73-1.9-.43ZM8 12.9a.9.9 0 1 1 0-1.8.9.9 0 0 1 0 1.8Z"/><path fill="#FCD116" d="m5.5 10.37-1.42-.4.69-1.53 1.54.68.4-1.42 1.48 1-.82 1.48-1.42-.4Zm-1.4-2.8.7 1.53 1.42-.4-.82-1.48-1.48 1 .4 1.42-1.54-.67Z"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h24v24H0z"/></clipPath></defs></svg>
            </button>
            <button id="persistent-refresh-btn" title="Start a New Round" class="text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-full p-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64M3.51 15A9 9 0 0 0 18.36 18.36"></path></svg>
            </button>
        </div>
        <h1 class="text-4xl sm:text-5xl font-bold text-blue-600 mb-2" data-key="main-title">Mad Lib Generator</h1>
        <p class="text-gray-500 text-lg mb-8" data-key="main-subtitle">A fun tool for creative thinking and hilarious explanations!</p>

        <div class="flex flex-col gap-6 mb-8">
            <input type="text" id="topicInput" data-key-placeholder="topic-placeholder" placeholder="Enter a topic, e.g., 'The Internet'" class="w-full px-5 py-4 text-lg border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-shadow">
            <div class="grid sm:grid-cols-2 gap-4">
                 <button id="generateBtn" data-key="generate-btn" class="w-full bg-blue-600 text-white font-bold text-lg uppercase tracking-wider py-4 rounded-xl hover:bg-blue-700 active:bg-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-300 transform hover:-translate-y-1 transition-all shadow-lg hover:shadow-xl">
                    Generate Prompt
                </button>
                 <button id="askAudienceBtn" data-key="ask-audience-btn" class="w-full bg-green-500 text-white font-bold text-lg uppercase tracking-wider py-4 rounded-xl hover:bg-green-600 active:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transform hover:-translate-y-1 transition-all shadow-lg hover:shadow-xl">
                    Ask The Audience
                </button>
            </div>
        </div>

        <div class="bg-gray-50 p-6 rounded-xl min-h-[120px] flex justify-center items-center border-2 border-dashed border-gray-300">
            <p id="result" class="text-xl sm:text-2xl font-medium text-gray-700 leading-relaxed" data-key="prompt-placeholder">Your prompt will appear here...</p>
        </div>
        
        <!-- Audience Submissions Area -->
        <div id="submissions-container" class="mt-8 hidden">
             <h2 class="text-2xl font-bold text-gray-700 mb-4" data-key="audience-ideas-title">Audience Ideas</h2>
             <div id="submissions-grid" class="max-h-[400px] overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 bg-gray-100 rounded-lg no-scrollbar">
                <!-- Bubbles will be inserted here -->
             </div>
             <button id="startVotingBtn" data-key="start-voting-btn" class="hidden mt-6 w-full bg-purple-500 text-white font-bold text-lg uppercase tracking-wider py-3 rounded-xl hover:bg-purple-600 focus:outline-none focus:ring-4 focus:ring-purple-300 shadow-lg">
                Start Voting!
             </button>
              <button id="endVotingBtn" data-key="show-winner-btn" class="hidden mt-6 w-full bg-red-500 text-white font-bold text-lg uppercase tracking-wider py-3 rounded-xl hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 shadow-lg">
                Show Winner!
             </button>
             <button id="newRoundBtn" data-key="new-round-btn" class="hidden mt-6 w-full bg-gray-600 text-white font-bold text-lg uppercase tracking-wider py-3 rounded-xl hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-300 shadow-lg">
                New Round
             </button>
        </div>


        <footer class="mt-8 text-xs text-gray-500 text-center space-y-2">
            <div class="flex justify-center items-center gap-4">
                <span data-key="footer-gemini">Created using Gemini 2.5 Pro</span>
                <span id="connection-status" class="w-3 h-3 rounded-full bg-gray-400" title="Connection Status"></span>
            </div>
            <p data-key="footer-privacy">Data is only temporarily stored during the game; no data is retained. For questions or feedback, contact <a href="mailto:gngo@ateneo.edu" class="text-blue-500 hover:underline">gngo@ateneo.edu</a>.</p>
            <p data-key="footer-license">Licensed under <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">Creative Commons BY-NC 4.0</a>. Enjoy!</p>
        </footer>
    </div>
    
    <!-- Audience View Container -->
    <div id="audience-view" class="hidden bg-white rounded-2xl shadow-xl p-8 sm:p-12 text-center w-full max-w-md">
        <div id="audience-prompt-display" class="bg-gray-100 p-4 rounded-lg mb-6 border border-gray-200 hidden text-base leading-relaxed">
            <!-- Prompt will be injected here -->
        </div>

        <h1 id="audience-title" class="text-3xl font-bold text-blue-600 mb-2" data-key="audience-title">Join the Fun!</h1>
        <p id="audience-instruction" class="text-gray-500 mb-6" data-key="audience-instruction-submit">Submit your fun persona idea below.</p>
        
        <div id="audience-submission-form">
            <input type="text" id="audienceInput" data-key-placeholder="audience-placeholder" placeholder="e.g., 'a talking tarsier'" class="w-full px-5 py-4 text-lg border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 transition-shadow mb-4">
            <button id="submitAudienceBtn" data-key="audience-submit-btn" class="w-full bg-blue-600 text-white font-bold text-lg uppercase tracking-wider py-4 rounded-xl hover:bg-blue-700 shadow-lg">Submit</button>
        </div>

        <div id="audience-voting-area" class="hidden w-full text-left">
             <p id="vote-counter" class="text-center font-bold text-lg text-purple-600 mb-4"></p>
            <!-- Audience voting options will appear here -->
        </div>
         <p id="thanks-message" data-key="thanks-message" class="hidden mt-6 text-xl font-semibold text-green-600">Thanks for your submission! Waiting for others...</p>
         <div id="winner-display-audience" class="hidden text-center">
            <p class="text-gray-600 mb-2" data-key="winner-audience-info">Voting has ended! The winner is:</p>
            <div class="bg-yellow-100 border-2 border-yellow-300 p-4 rounded-lg">
                <p id="winning-text-audience" class="text-xl font-bold text-yellow-800"></p>
            </div>
         </div>
         <footer class="mt-8 text-xs text-gray-500 text-center space-y-1">
            <p data-key="footer-privacy-short">Data is temporarily stored and not retained.</p>
            <p data-key="footer-license-short">Licensed under <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">CC BY-NC 4.0</a>.</p>
        </footer>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 text-center relative max-w-sm w-full">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h2 class="text-2xl font-bold text-blue-600 mb-4" data-key="qr-title">Scan to Join!</h2>
            <p class="text-gray-600 mb-6" data-key="qr-instruction">Ask your audience to scan this QR code or use the link below.</p>
            <div id="qrcode" class="flex justify-center mb-4"></div>
            <div class="relative">
                <input type="text" id="session-link" readonly class="w-full bg-gray-100 border-2 border-gray-300 rounded-lg p-2 text-center text-sm">
                <button id="copy-link-btn" class="absolute right-1 top-1/2 -translate-y-1/2 bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded" data-key="copy-btn">COPY</button>
            </div>
            <p id="session-id-display" class="mt-4 text-sm text-gray-500 font-mono"></p>
        </div>
    </div>
    
    <!-- Winner Modal -->
    <div id="winner-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-10 text-center relative w-full max-w-md transform scale-95 transition-transform">
             <h2 class="text-4xl font-bold text-yellow-500 mb-4" data-key="winner-title">We have a winner!</h2>
             <div class="bg-yellow-100 border-4 border-yellow-300 p-6 rounded-lg my-6">
                <p id="winning-text" class="text-2xl font-bold text-gray-800"></p>
                <p id="winning-votes" class="text-lg text-gray-600 mt-2"></p>
             </div>
             <button id="close-winner-modal" class="mt-4 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg" data-key="close-btn">Close</button>
        </div>
    </div>
    <canvas id="confetti-canvas"></canvas>


    <!-- Notification Element -->
    <div id="notification" class="hidden fixed top-5 right-5 bg-red-500 text-white py-3 px-5 rounded-lg shadow-lg z-50" style="transform: translateX(120%);">
        <p id="notification-message"></p>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, updateDoc, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        let db, auth, userId, currentSessionId;
        let unsubscribeSubmissions = null; 
        let unsubscribeSession = null;
        let currentLanguage = 'en';
        const MAX_VOTES = 3;
        let votesUsed = 0;
        let votedForIds = [];

        const appId = 'madlibs-app';
        
        // --- DOM ELEMENTS ---
        const presenter_view = document.getElementById('presenter-view');
        const audience_view = document.getElementById('audience-view');
        const languageToggleBtn = document.getElementById('language-toggle-btn');
        const persistentRefreshBtn = document.getElementById('persistent-refresh-btn');
        const topicInput = document.getElementById('topicInput');
        const generateBtn = document.getElementById('generateBtn');
        const askAudienceBtn = document.getElementById('askAudienceBtn');
        const resultElement = document.getElementById('result');
        const submissionsContainer = document.getElementById('submissions-container');
        const submissionsGrid = document.getElementById('submissions-grid');
        const startVotingBtn = document.getElementById('startVotingBtn');
        const endVotingBtn = document.getElementById('endVotingBtn');
        const newRoundBtn = document.getElementById('newRoundBtn');
        const audienceInput = document.getElementById('audienceInput');
        const audiencePromptDisplay = document.getElementById('audience-prompt-display');
        const submitAudienceBtn = document.getElementById('submitAudienceBtn');
        const audienceSubmissionForm = document.getElementById('audience-submission-form');
        const audienceVotingArea = document.getElementById('audience-voting-area');
        const voteCounter = document.getElementById('vote-counter');
        const thanksMessage = document.getElementById('thanks-message');
        const winnerDisplayAudience = document.getElementById('winner-display-audience');
        const winningTextAudience = document.getElementById('winning-text-audience');
        const qrModal = document.getElementById('qr-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const qrcodeContainer = document.getElementById('qrcode');
        const sessionLinkInput = document.getElementById('session-link');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const sessionIdDisplay = document.getElementById('session-id-display');
        const winnerModal = document.getElementById('winner-modal');
        const winningText = document.getElementById('winning-text');
        const winningVotes = document.getElementById('winning-votes');
        const closeWinnerModal = document.getElementById('close-winner-modal');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        const connectionStatus = document.getElementById('connection-status');
       
        // --- FIREBASE SETUP ---
        async function setupFirebase() {
            // Hardcoded Firebase configuration provided by the user.
            const firebaseConfig = {
              apiKey: "AIzaSyBkbkMOuCCPMGapoJ5tIGnDUE7IZGhk-RA",
              authDomain: "madlibs-76c98.firebaseapp.com",
              projectId: "madlibs-76c98",
              storageBucket: "madlibs-76c98.appspot.com",
              messagingSenderId: "537595073122",
              appId: "1:537595073122:web:ba3e61e2809db02982773b"
            };

            try {
                if (!firebaseConfig.apiKey) {
                   throw new Error("Firebase config is missing.");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                updateConnectionStatus(true);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        await signInAnonymously(auth);
                    }
                    main();
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e.message);
                updateConnectionStatus(false);
                main(); 
            }
        }

        // --- APP INITIALIZATION ---
        function main() {
            const params = new URLSearchParams(window.location.search);
            currentSessionId = params.get('session');
            const lang = params.get('lang');
            if(lang) currentLanguage = lang;
            
            updateUIText();
            if (currentSessionId) {
                initializeAudienceView();
            } else {
                initializePresenterView();
            }
        }
        
        // --- PRESENTER LOGIC ---
        function initializePresenterView() {
            presenter_view.classList.remove('hidden');
            audience_view.classList.add('hidden');
            languageToggleBtn.addEventListener('click', toggleLanguage);
            persistentRefreshBtn.addEventListener('click', resetForNewRound);
            generateBtn.addEventListener('click', generateMadLib);
            topicInput.addEventListener('keyup', (event) => event.key === 'Enter' && generateMadLib());
            askAudienceBtn.addEventListener('click', handleAskAudience);
            closeModalBtn.addEventListener('click', () => qrModal.classList.add('hidden'));
            startVotingBtn.addEventListener('click', handleStartVoting);
            endVotingBtn.addEventListener('click', handleEndVoting);
            newRoundBtn.addEventListener('click', resetForNewRound);
            closeWinnerModal.addEventListener('click', () => {
                winnerModal.classList.add('hidden');
                winnerModal.querySelector('div').classList.add('scale-95');
            });
            copyLinkBtn.addEventListener('click', copySessionLink);
        }

        async function handleAskAudience() {
            if (!db) { return showNotification("Real-time features are disabled.", 'error');}
            currentSessionId = generateSessionId();
            const sessionRef = doc(db, `artifacts/${appId}/public/data/madlibs_sessions`, currentSessionId);
            const currentPrompt = resultElement.innerHTML;

            await setDoc(sessionRef, { 
                votingOpen: false, 
                winnerAnnounced: false, 
                createdAt: new Date(),
                prompt: currentPrompt 
            });

            const url = `http://galvinradleyngo.github.io/madlib/?session=${currentSessionId}&lang=${currentLanguage}`;
            qrcodeContainer.innerHTML = '';
            new QRCode(qrcodeContainer, { text: url, width: 180, height: 180 });
            sessionLinkInput.value = url;
            sessionIdDisplay.textContent = `Session ID: ${currentSessionId}`;
            qrModal.classList.remove('hidden');
            listenForSubmissions();
        }

        function listenForSubmissions() {
            submissionsContainer.classList.remove('hidden');
            submissionsGrid.innerHTML = '';
            const submissionsRef = collection(db, `artifacts/${appId}/public/data/madlibs_sessions/${currentSessionId}/submissions`);
            if(unsubscribeSubmissions) unsubscribeSubmissions();
            unsubscribeSubmissions = onSnapshot(submissionsRef, (snapshot) => {
                startVotingBtn.classList.toggle('hidden', snapshot.empty);
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added")   renderBubble(change.doc.id, change.doc.data(), 'presenter');
                    if (change.type === "modified") updateBubbleVotes(change.doc.id, change.doc.data());
                });
            });
        }
        
        async function handleStartVoting() {
             const sessionRef = doc(db, `artifacts/${appId}/public/data/madlibs_sessions`, currentSessionId);
             await updateDoc(sessionRef, { votingOpen: true });
             startVotingBtn.classList.add('hidden');
             endVotingBtn.classList.remove('hidden');
        }

        async function handleEndVoting() {
            endVotingBtn.disabled = true;
            const submissionsRef = collection(db, `artifacts/${appId}/public/data/madlibs_sessions/${currentSessionId}/submissions`);
            const snapshot = await getDocs(submissionsRef);
            if (snapshot.empty) {
                endVotingBtn.disabled = false;
                return;
            }

            let winner = { votes: -1 };
            snapshot.forEach(doc => {
                if (doc.data().votes > winner.votes) {
                    winner = { id: doc.id, ...doc.data() };
                }
            });

            const sessionRef = doc(db, `artifacts/${appId}/public/data/madlibs_sessions`, currentSessionId);
            await updateDoc(sessionRef, { winnerAnnounced: true, winner: winner });
            
            winningText.textContent = `"${winner.text}"`;
            winningVotes.textContent = `${winner.votes} ${currentLanguage === 'en' ? 'Votes' : 'Boto'}`;
            winnerModal.classList.remove('hidden');
            setTimeout(() => winnerModal.querySelector('div').classList.remove('scale-95'), 10);
            
            triggerConfetti();
            endVotingBtn.classList.add('hidden');
            newRoundBtn.classList.remove('hidden');
            endVotingBtn.disabled = false;
        }

        function resetForNewRound() {
            winnerModal.classList.add('hidden');
            submissionsContainer.classList.add('hidden');
            endVotingBtn.classList.add('hidden');
            newRoundBtn.classList.add('hidden');
            startVotingBtn.classList.add('hidden');

            submissionsGrid.innerHTML = '';
            resultElement.innerHTML = uiTranslations[currentLanguage]['prompt-placeholder'];
            topicInput.value = '';
            
            if (unsubscribeSubmissions) {
                unsubscribeSubmissions();
                unsubscribeSubmissions = null;
            }
            if (unsubscribeSession) {
                unsubscribeSession();
                unsubscribeSession = null;
            }
            currentSessionId = null;
            showNotification(uiTranslations[currentLanguage]['new-round-notification'], 'success');
        }

        // --- AUDIENCE LOGIC ---
        function initializeAudienceView() {
            presenter_view.classList.add('hidden');
            audience_view.classList.remove('hidden');
            submitAudienceBtn.addEventListener('click', handleAudienceSubmit);
            audienceInput.addEventListener('keyup', (event) => event.key === 'Enter' && handleAudienceSubmit());
            listenForSessionState();
        }

        async function handleAudienceSubmit() {
            const text = audienceInput.value.trim();
            if (text && db) {
                const submissionsRef = collection(db, `artifacts/${appId}/public/data/madlibs_sessions/${currentSessionId}/submissions`);
                await addDoc(submissionsRef, { text, votes: 0, author: userId });
                audienceSubmissionForm.classList.add('hidden');
                thanksMessage.classList.remove('hidden');
            }
        }
        
        function listenForSessionState() {
             const sessionRef = doc(db, `artifacts/${appId}/public/data/madlibs_sessions`, currentSessionId);
             if(unsubscribeSession) unsubscribeSession();
             unsubscribeSession = onSnapshot(sessionRef, (docSnap) => {
                 if (!docSnap.exists()) return;
                 const sessionData = docSnap.data();

                 if (sessionData.prompt && sessionData.prompt !== uiTranslations['en']['prompt-placeholder'] && sessionData.prompt !== uiTranslations['fil']['prompt-placeholder']) {
                    audiencePromptDisplay.innerHTML = sessionData.prompt;
                    audiencePromptDisplay.classList.remove('hidden');
                 }

                 if (sessionData.winnerAnnounced) {
                    audienceSubmissionForm.classList.add('hidden');
                    thanksMessage.classList.add('hidden');
                    audienceVotingArea.classList.add('hidden');
                    winnerDisplayAudience.classList.remove('hidden');
                    winningTextAudience.textContent = `"${sessionData.winner.text}"`;
                    if(unsubscribeSubmissions) unsubscribeSubmissions();
                 } else if (sessionData.votingOpen) {
                     thanksMessage.classList.add('hidden');
                     audienceSubmissionForm.classList.add('hidden');
                     audienceVotingArea.classList.remove('hidden');
                     document.getElementById('audience-title').textContent = uiTranslations[currentLanguage]['audience-title-vote'];
                     document.getElementById('audience-instruction').textContent = uiTranslations[currentLanguage]['audience-instruction-vote'];
                     updateVoteCounter();
                     loadVotingOptions();
                 }
             });
        }
        
        function loadVotingOptions() {
            const submissionsRef = collection(db, `artifacts/${appId}/public/data/madlibs_sessions/${currentSessionId}/submissions`);
            if(unsubscribeSubmissions) unsubscribeSubmissions();
            unsubscribeSubmissions = onSnapshot(submissionsRef, (snapshot) => {
                audienceVotingArea.innerHTML = '';
                // Re-add counter as innerHTML is cleared
                audienceVotingArea.appendChild(voteCounter); 
                updateVoteCounter();
                snapshot.forEach(doc => renderBubble(doc.id, doc.data(), 'audience'));
            });
        }

        async function handleVote(docId) {
             if (!db) return;
             const submissionRef = doc(db, `artifacts/${appId}/public/data/madlibs_sessions/${currentSessionId}/submissions`, docId);
             const isAlreadyVoted = votedForIds.includes(docId);

             if (isAlreadyVoted) {
                 // Un-voting
                 await updateDoc(submissionRef, { votes: increment(-1) });
                 votedForIds = votedForIds.filter(id => id !== docId);
                 votesUsed--;
             } else {
                 // Voting
                 if (votesUsed >= MAX_VOTES) {
                     return showNotification(uiTranslations[currentLanguage]['max-votes-notification'], 'error');
                 }
                 await updateDoc(submissionRef, { votes: increment(1) });
                 votedForIds.push(docId);
                 votesUsed++;
             }
             updateVoteCounter();
             updateBubbleSelection(docId, !isAlreadyVoted);
        }

        // --- SHARED UI LOGIC ---
        function renderBubble(id, data, viewType) {
             const isPresenter = viewType === 'presenter';
             const container = isPresenter ? submissionsGrid : audienceVotingArea;
             const bubble = document.createElement('div');
             bubble.id = `bubble-${viewType}-${id}`;

             if (isPresenter) {
                 bubble.className = "bubble bg-white p-4 rounded-lg shadow text-center break-words";
                 bubble.innerHTML = `<p class="text-gray-800 text-lg">${data.text}</p><span class="vote-count font-bold text-xl text-blue-600 mt-2 block">${data.votes || 0}</span>`;
             } else {
                 bubble.className = "bubble-vote w-full bg-white p-4 my-2 rounded-lg shadow text-left break-words cursor-pointer transition-transform hover:scale-105";
                 bubble.innerHTML = `<span class="vote-count float-right font-bold text-blue-600 text-lg">${data.votes || 0}</span><p class="text-gray-800">${data.text}</p>`;
                 bubble.addEventListener('click', () => handleVote(id));
                 if (votedForIds.includes(id)) {
                    bubble.classList.add('ring-4', 'ring-purple-400');
                 }
             }
             container.appendChild(bubble);
        }

        function updateBubbleVotes(docId, data) {
            ['presenter', 'audience'].forEach(viewType => {
                const bubble = document.getElementById(`bubble-${viewType}-${docId}`);
                if(bubble) {
                    const voteCountEl = bubble.querySelector('.vote-count');
                    if(voteCountEl) voteCountEl.textContent = data.votes || 0;
                }
            });
        }

        function updateBubbleSelection(docId, isSelected) {
            const bubble = document.getElementById(`bubble-audience-${docId}`);
            if (bubble) bubble.classList.toggle('ring-4', isSelected);
            if (bubble) bubble.classList.toggle('ring-purple-400', isSelected);
        }

        function updateVoteCounter() {
            const votesLeft = MAX_VOTES - votesUsed;
            if(currentLanguage === 'en'){
                voteCounter.textContent = `Votes Remaining: ${votesLeft}`;
            } else {
                voteCounter.textContent = `Natitirang Boto: ${votesLeft}`;
            }
        }
        
        // --- TRANSLATION & LANGUAGE LOGIC ---
        const uiTranslations = {
            en: {
                'main-title': 'Mad Lib Generator',
                'main-subtitle': 'A fun tool for creative thinking and hilarious explanations!',
                'topic-placeholder': "Enter a topic, e.g., 'The Internet'",
                'generate-btn': 'Generate Prompt',
                'ask-audience-btn': 'Ask The Audience',
                'prompt-placeholder': 'Your prompt will appear here...',
                'audience-ideas-title': 'Audience Ideas',
                'start-voting-btn': 'Start Voting!',
                'show-winner-btn': 'Show Winner!',
                'new-round-btn': 'New Round',
                'audience-title': 'Join the Fun!',
                'audience-instruction-submit': 'Submit your fun persona idea below.',
                'audience-placeholder': "e.g., 'a talking tarsier'",
                'audience-submit-btn': 'Submit',
                'thanks-message': 'Thanks for your submission! Waiting for others...',
                'winner-audience-info': 'Voting has ended! The winner is:',
                'qr-title': 'Scan to Join!',
                'qr-instruction': 'Ask your audience to scan this QR code or use the link below.',
                'copy-btn': 'COPY',
                'winner-title': 'We have a winner!',
                'close-btn': 'Close',
                'footer-gemini': 'Created using Gemini 2.5 Pro',
                'footer-privacy': 'Data is only temporarily stored during the game; no data is retained. For questions or feedback, contact <a href="mailto:gngo@ateneo.edu" class="text-blue-500 hover:underline">gngo@ateneo.edu</a>.',
                'footer-license': 'Licensed under <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">Creative Commons BY-NC 4.0</a>. Enjoy!',
                'footer-privacy-short': 'Data is temporarily stored and not retained.',
                'footer-license-short': 'Licensed under <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">CC BY-NC 4.0</a>.',
                'audience-title-vote': 'Vote for your Favorite!',
                'audience-instruction-vote': 'You have 3 votes. Tap to vote or un-vote.',
                'max-votes-notification': 'You have used all 3 votes!',
                'new-round-notification': 'Ready for a new round!',
            },
            fil: {
                'main-title': 'Mad Lib Generator',
                'main-subtitle': 'Isang masayang laro para sa malikhaing pag-iisip!',
                'topic-placeholder': "Maglagay ng paksa, e.g., 'Ang Internet'",
                'generate-btn': 'Bumuo ng Prompt',
                'ask-audience-btn': 'Tanungin ang Audience',
                'prompt-placeholder': 'Lalabas dito ang iyong prompt...',
                'audience-ideas-title': 'Mga Ideya ng Audience',
                'start-voting-btn': 'Simulan ang Boto!',
                'show-winner-btn': 'Ipakita ang Nanalo!',
                'new-round-btn': 'Bagong Round',
                'audience-title': 'Sali na sa Kasiyahan!',
                'audience-instruction-submit': 'Isumite ang iyong ideya sa ibaba.',
                'audience-placeholder': "e.g., 'isang nagsasalitang tarsier'",
                'audience-submit-btn': 'Ipasa',
                'thanks-message': 'Salamat sa iyong sinumite! Hinihintay ang iba...',
                'winner-audience-info': 'Tapos na ang botohan! Ang nanalo ay:',
                'qr-title': 'I-scan para Sumali!',
                'qr-instruction': 'I-scan ang QR code na ito o gamitin ang link sa ibaba.',
                'copy-btn': 'KOPI',
                'winner-title': 'Mayroon tayong nanalo!',
                'close-btn': 'Isara',
                'footer-gemini': 'Nilikha gamit ang Gemini 2.5 Pro',
                'footer-privacy': 'Pansamantala lamang iniimbak ang data habang naglalaro; walang datos na itinatabi. Para sa mga tanong, kontakin si <a href="mailto:gngo@ateneo.edu" class="text-blue-500 hover:underline">gngo@ateneo.edu</a>.',
                'footer-license': 'Lisensyado sa ilalim ng <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">Creative Commons BY-NC 4.0</a>. Enjoy!',
                'footer-privacy-short': 'Pansamantala lamang iniimbak ang data.',
                'footer-license-short': 'Lisensyado sa ilalim ng <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">CC BY-NC 4.0</a>.',
                'audience-title-vote': 'Bumoto para sa iyong Paborito!',
                'audience-instruction-vote': 'Mayroon kang 3 boto. Pindutin para bumoto o alisin ang boto.',
                'max-votes-notification': 'Nagami mo na ang iyong 3 boto!',
                'new-round-notification': 'Handa na para sa bagong round!',
            }
        };

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'fil' : 'en';
            updateUIText();
            if (topicInput.value || resultElement.innerHTML.includes('<strong>')) {
                generateMadLib();
            }
        }
        
        function updateUIText() {
            const translations = uiTranslations[currentLanguage];
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.dataset.key;
                if(translations[key]) el.innerHTML = translations[key];
            });
             document.querySelectorAll('[data-key-placeholder]').forEach(el => {
                const key = el.dataset.keyPlaceholder;
                if(translations[key]) el.placeholder = translations[key];
            });
        }
        
        // --- OFFLINE/CLASSIC LOGIC ---
        const personas_en = [
             'a 5-year-old kid', 'a moody teenager', 'a wise 90-year-old lola', 'a "Tita" of Manila', 'a recent college graduate', 'a tired new parent', 'a jeepney driver stuck in EDSA traffic', 'a friendly call center agent on their break', 'a "tindera" at a sari-sari store', 'a hardworking rice farmer from the province', 'a mall security guard', 'an OFW on a video call', 'a GrabFood delivery rider', 'a NASA astronaut', 'a skeptical scientist', 'a dramatic theater actor', 'a busy corporate lawyer', 'a world-famous chef', 'a software developer who only speaks in code', 'a very confused historian', 
             'Jollibee', 'Darna', 'Cardo Dalisay from "Ang Probinsyano"', 'a certified "Marites" (neighborhood gossiper)', 'Vice Ganda', 'Manny Pacquiao', 'Hidilyn Diaz', 'Catriona Gray', 'Heart Evangelista', 'Jose Rizal', 'Heneral Luna', 'Popoy from "One More Chance"', 'a KathNiel super-fan', 'a K-Pop idol from BTS', 'a member of Blackpink', 'Taylor Swift', 'Iron Man', 'Elsa from Frozen', 'SpongeBob SquarePants', 'Pikachu', 'Harry Potter', 'Luffy from One Piece', 'a Jedi Knight', 
             'a character from a Jose Rizal novel', 'an alien who just landed in Quiapo', 'a time traveler from the Spanish colonial era', 'a talking tarsier from Bohol', 'your future self from the year 2050', 'a ghost from Balete Drive', 'a super-intelligent AI', 'a golden retriever', 'a cat that is judging you', 'someone who just woke up from a 20-year coma', 'a conspiracy theorist', 'a hopeless romantic', 'a complete cynic', 'a dragon', 'a mermaid from the seas of Palawan', 'someone who has never used a smartphone',
             'a TikTok influencer filming a video', 'a "plantita" talking to her favorite plant', 'a "barker" at a jeepney terminal', 'a street food vendor selling isaw', 'a professional Mobile Legends player', 'Batman', 'your pet dog who suddenly understands English', 'a first-time tourist in Manila', 'a beauty pageant contestant', 'a pirate who just found treasure', 'a vampire who is afraid of blood', 'Santa Claus on his summer vacation', 'a PBA basketball player', 'a BPO employee on a night shift', 'a history professor', 'a student cramming for an exam', 'a fortune teller', 'a stand-up comedian', 'a famous vlogger doing a collab', 'Jessica Soho', 'Apo Whang-od', 'a food blogger reviewing crispy pata'
        ];

        const personas_fil = [
            { text: 'isang 5 taong gulang na bata', marker: 'sa' },
            { text: 'isang mainiting tinedyer', marker: 'sa' },
            { text: 'isang matalinong 90-anyos na lola', marker: 'sa' },
            { text: 'isang "Tita" ng Maynila', marker: 'sa' },
            { text: 'isang tsuper ng jeep na na-trapik sa EDSA', marker: 'sa' },
            { text: 'isang tindera sa sari-sari store', marker: 'sa' },
            { text: 'isang magsasaka mula sa probinsya', marker: 'sa' },
            { text: 'isang guwardiya sa mall', marker: 'sa' },
            { text: 'isang OFW sa video call', marker: 'sa' },
            { text: 'isang GrabFood delivery rider', marker: 'sa' },
            { text: 'isang astronaut ng NASA', marker: 'sa' },
            { text: 'isang madramang aktor sa teatro', marker: 'sa' },
            { text: 'Jollibee', marker: 'kay' },
            { text: 'Darna', marker: 'kay' },
            { text: 'Cardo Dalisay', marker: 'kay' },
            { text: 'isang sertipikadong "Marites"', marker: 'sa' },
            { text: 'Vice Ganda', marker: 'kay' },
            { text: 'Manny Pacquiao', marker: 'kay' },
            { text: 'Hidilyn Diaz', marker: 'kay' },
            { text: 'Catriona Gray', marker: 'kay' },
            { text: 'Heart Evangelista', marker: 'kay' },
            { text: 'Jose Rizal', marker: 'kay' },
            { text: 'Heneral Luna', marker: 'kay' },
            { text: 'Popoy ng "One More Chance"', marker: 'kay' },
            { text: 'KathNiel', marker: 'kina' },
            { text: 'mga miyembro ng Blackpink', marker: 'sa' },
            { text: 'Taylor Swift', marker: 'kay' },
            { text: 'Iron Man', marker: 'kay' },
            { text: 'Elsa ng Frozen', marker: 'kay' },
            { text: 'SpongeBob SquarePants', marker: 'kay' },
            { text: 'Pikachu', marker: 'kay' },
            { text: 'Harry Potter', marker: 'kay' },
            { text: 'isang alien na kalalapag lang sa Quiapo', marker: 'sa' },
            { text: 'isang time traveler mula sa panahon ng Kastila', marker: 'sa' },
            { text: 'isang nagsasalitang tarsier mula sa Bohol', marker: 'sa' },
            { text: 'isang multo sa Balete Drive', marker: 'sa' },
            { text: 'isang super-intelligent na AI', marker: 'sa' },
            { text: 'isang pusa na nanghuhusga sa iyo', marker: 'sa' },
            { text: 'isang taong kagigising lang mula sa 20-taong coma', marker: 'sa' },
            { text: 'isang TikTok influencer', marker: 'sa' },
            { text: 'isang "plantita"', marker: 'sa' },
            { text: 'isang "barker" sa terminal ng jeep', marker: 'sa' },
            { text: 'isang nagtitinda ng isaw', marker: 'sa' },
            { text: 'isang professional Mobile Legends player', marker: 'sa' },
            { text: 'Batman', marker: 'kay' },
            { text: 'aso mo na biglang nakaintindi ng Tagalog', marker: 'sa' },
            { text: 'isang turista sa Maynila', marker: 'sa' },
            { text: 'isang beauty pageant contestant', marker: 'sa' },
            { text: 'isang pirata na nakahanap ng kayamanan', marker: 'sa' },
            { text: 'isang bampira na takot sa dugo', marker: 'sa' },
            { text: 'Santa Claus na nagbabakasyon', marker: 'kay' },
            { text: 'isang manlalaro ng PBA', marker: 'sa' },
            { text: 'isang BPO employee na night shift', marker: 'sa' },
            { text: 'isang estudyanteng nagka-cram para sa exam', marker: 'sa' },
            { text: 'isang manghuhula', marker: 'sa' },
            { text: 'isang stand-up comedian', marker: 'sa' },
            { text: 'isang sikat na vlogger', marker: 'sa' },
            { text: 'Apo Whang-od', marker: 'kay' },
            { text: 'Jessica Soho', marker: 'kay' }
        ];

        function generateMadLib() {
            let topic, newPromptHTML;
            
            if (currentLanguage === 'en') {
                topic = topicInput.value.trim() || "(your amazing topic)";
                const randomPersona = personas_en[Math.floor(Math.random() * personas_en.length)];
                newPromptHTML = `Explain <strong class="inline-block align-middle text-blue-600 bg-blue-100 py-1 px-2 rounded-md mx-1">${topic}</strong> to <strong class="inline-block align-middle text-blue-600 bg-blue-100 py-1 px-2 rounded-md mx-1">${randomPersona}</strong>.`;
            } else {
                topic = topicInput.value.trim() || "(iyong pambihirang paksa)";
                const personaObj = personas_fil[Math.floor(Math.random() * personas_fil.length)];
                newPromptHTML = `Ipaliwanag mo ang <strong class="inline-block align-middle text-blue-600 bg-blue-100 py-1 px-2 rounded-md mx-1">${topic}</strong> ${personaObj.marker} <strong class="inline-block align-middle text-blue-600 bg-blue-100 py-1 px-2 rounded-md mx-1">${personaObj.text}</strong>.`;
            }
            
            resultElement.innerHTML = newPromptHTML;

            if (currentSessionId && db) {
                const sessionRef = doc(db, `artifacts/${appId}/public/data/madlibs_sessions`, currentSessionId);
                updateDoc(sessionRef, { prompt: newPromptHTML }).catch(err => console.error("Failed to update prompt:", err));
            }
        }

        // --- UTILITY FUNCTIONS ---
        function generateSessionId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function copySessionLink() {
            sessionLinkInput.select();
            document.execCommand('copy');
            const copyBtn = document.getElementById('copy-link-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = uiTranslations[currentLanguage]['copy-btn'] === 'COPY' ? 'COPIED!' : 'NAKOPI!';
            setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
        }

        function updateConnectionStatus(isConnected) {
            connectionStatus.classList.toggle('bg-green-500', isConnected);
            connectionStatus.classList.toggle('bg-red-500', !isConnected);
            connectionStatus.title = isConnected ? "Connected to Firebase" : "Disconnected. Real-time features are offline.";
        }

        function showNotification(message, type = 'error') {
            notificationMessage.textContent = message;
            notification.classList.toggle('bg-red-500', type === 'error');
            notification.classList.toggle('bg-green-500', type !== 'error');
            notification.classList.remove('hidden');
            setTimeout(() => { notification.style.transform = 'translateX(0)'; }, 10);
            setTimeout(() => { notification.style.transform = 'translateX(120%)';}, 4000);
        }

        function triggerConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            let confetti = [];
            const confettiCount = 200;
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'];

            for (let i = 0; i < confettiCount; i++) {
                confetti.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    size: Math.random() * 5 + 2,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * 360,
                    spin: (Math.random() - 0.5) * 10,
                });
            }

            function drawConfetti() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                confetti.forEach((p, i) => {
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.angle * Math.PI / 180);
                    ctx.rect(-p.size / 2, -p.size / 2, p.size, p.size);
                    ctx.fill();
                    ctx.restore();
                    
                    p.y += p.speed;
                    p.angle += p.spin;

                    if (p.y > canvas.height) {
                        confetti.splice(i, 1);
                    }
                });
            }

            let animationFrameId;
            function animate() {
                drawConfetti();
                if (confetti.length > 0) {
                    animationFrameId = requestAnimationFrame(animate);
                } else {
                    ctx.clearRect(0,0, canvas.width, canvas.height);
                }
            }
            animate();
            setTimeout(() => cancelAnimationFrame(animationFrameId), 5000); // Stop after 5s
        }

        // Start the application
        setupFirebase();

    </script>
</body>
</html>

